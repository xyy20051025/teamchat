<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>趣唠 - 贪吃蛇大作战</title>
    <link href="/static/layui/layui-v2.13.3/layui/css/layui.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Segoe UI', sans-serif;
            overflow: hidden;
            user-select: none;
        }
        
        /* Anime/Kawaii UI Theme - Refined */
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Varela+Round&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #ffe6f2; /* Light Pink BG */
            background-image: radial-gradient(#ffcce6 15%, transparent 16%), radial-gradient(#ffcce6 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            color: #555;
            font-family: 'Varela Round', 'Comic Sans MS', sans-serif;
            overflow: hidden;
            user-select: none;
        }
        
        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Floating animation for container background elements if any */
        }

        .panel {
            background: rgba(255, 255, 255, 0.9);
            border: 6px solid #fff;
            box-shadow: 0 15px 35px rgba(255, 183, 178, 0.4);
            border-radius: 40px;
            padding: 50px;
            text-align: center;
            max-width: 900px;
            width: 85%;
            position: relative;
            animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .panel-header {
            font-family: 'Fredoka One', cursive;
            font-size: 3.5rem;
            margin-bottom: 40px;
            color: #ff8fa3; /* Darker Pink */
            text-shadow: 4px 4px 0px #fff, 6px 6px 0px #ffc2d1;
            letter-spacing: 3px;
        }

        .btn-anime {
            background: #ffb7b2;
            background: linear-gradient(to bottom, #ffb7b2 0%, #ff9aa2 100%);
            border: 4px solid #fff;
            color: #fff;
            padding: 18px 50px;
            font-size: 1.5rem;
            margin: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 60px;
            font-family: 'Fredoka One', cursive;
            box-shadow: 0 8px 0 #ff7eb9, 0 15px 20px rgba(0,0,0,0.1);
            position: relative;
            top: 0;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
            min-width: 250px;
        }

        .btn-anime:hover {
            background: linear-gradient(to bottom, #ffc2d1 0%, #ffb7b2 100%);
            transform: translateY(-4px);
            box-shadow: 0 12px 0 #ff7eb9, 0 20px 25px rgba(0,0,0,0.15);
        }

        .btn-anime:active {
            top: 8px;
            box-shadow: 0 0 0 #ff7eb9, 0 0 5px rgba(0,0,0,0.1);
            transform: translateY(4px);
        }

        /* Lobby Styles */
        .lobby-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            font-size: 1.4rem;
            color: #777;
            background: #fff0f5;
            padding: 15px 30px;
            border-radius: 25px;
            border: 3px solid #fff;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .lobby-content {
            display: flex;
            gap: 20px;
            height: 350px;
        }

        .player-list {
            background: #fff;
            flex: 1;
            overflow-y: auto;
            border: 4px dashed #ffb7b2;
            border-radius: 25px;
            padding: 15px;
        }

        .lobby-chat {
            flex: 1;
            background: #fff;
            border: 4px dashed #c7ceea;
            border-radius: 25px;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .lobby-chat-msgs {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            text-align: left;
            padding: 5px;
        }
        
        .lobby-chat-input {
            display: flex;
        }
        
        .lobby-chat-input input {
            flex: 1;
            border: 2px solid #c7ceea;
            border-radius: 20px;
            padding: 8px 15px;
            outline: none;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: none;
            color: #666;
            background: #fdfdfd;
            margin-bottom: 10px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            transition: transform 0.2s;
        }
        
        .player-item:hover {
            transform: scale(1.02);
            background: #fff9fc;
        }
        
        .player-item img {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            margin-right: 20px;
            border: 4px solid #ff9aa2;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Game Canvas Container */
        .game-layout {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
        }

        #gameCanvas {
            background: #fff;
            border: 10px solid #fff;
            border-radius: 30px;
            box-shadow: 0 20px 50px rgba(255, 154, 162, 0.3);
            display: block;
            cursor: crosshair;
        }

        .scoreboard {
            /* Position relative to flex container */
            position: static;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 25px;
            border: 4px solid #fff;
            color: #555;
            min-width: 180px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            font-family: 'Varela Round', sans-serif;
            height: fit-content;
        }
        
        .scoreboard h4 {
            font-family: 'Fredoka One', cursive;
            color: #ff9aa2;
            font-size: 1.2rem;
            margin-top: 0;
        }
        
        .chat-overlay {
            position: static;
            width: 300px;
            background: rgba(255,255,255,0.95);
            border-radius: 25px;
            border: 4px solid #fff;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 300px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 0.9rem;
            text-align: left;
        }

        .chat-input {
            padding: 10px;
            border-top: 2px solid #ffe6f2;
            background: #fff;
        }

        .chat-input input {
            width: 100%;
            box-sizing: border-box;
            border-radius: 30px;
            padding: 10px 20px;
            border: 2px solid #ffe6f2;
        }
        
        .chat-input input:focus {
            border-color: #ff9aa2;
        }

        /* Join Input */
        .join-input {
            background: #fff;
            border: 3px solid #ffb7b2;
            color: #555;
            padding: 15px;
            margin-right: 15px;
            font-size: 1.3rem;
            width: 200px;
            text-align: center;
            border-radius: 50px;
            font-family: 'Varela Round', sans-serif;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.05);
        }
        
        .join-input:focus {
            border-color: #ff9aa2;
            outline: none;
            box-shadow: 0 0 0 4px rgba(255, 154, 162, 0.2);
        }

        /* Screens - Restored */
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .back-btn {
            position: absolute;
            top: 25px;
            left: 25px;
            z-index: 999;
            cursor: pointer;
            background: #fff;
            color: #ff9aa2;
            padding: 15px;
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            transform: scale(1.1) rotate(-10deg);
            color: #ff6f91;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        /* Settings UI */
        .settings-btn {
            position: absolute;
            top: 25px;
            right: 25px;
            z-index: 999;
            cursor: pointer;
            background: #fff;
            color: #ff9aa2;
            padding: 15px;
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            width: 25px;
            height: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
        }

        .settings-btn:hover {
            transform: rotate(90deg) scale(1.1);
            color: #ff6f91;
        }

        .settings-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: 5px solid #ff9aa2;
            z-index: 2000;
            width: 300px;
            text-align: center;
            animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toggle-switch {
            width: 60px;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #ffdac1;
        }

        .toggle-knob {
            width: 26px;
            height: 26px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.3s, background 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle-knob.active {
            left: 32px;
            background: #ff9aa2;
        }


    </style>
</head>
<body>

    <audio id="bgm-menu" loop preload="auto">
        <source src="{{ url_for('static', filename='audio/caidan_bgm.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="bgm-game" loop preload="auto">
        <source src="{{ url_for('static', filename='audio/game_bgm.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="sfx-eat" preload="auto">
        <source src="{{ url_for('static', filename='audio/eat.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="sfx-die" preload="auto">
        <source src="{{ url_for('static', filename='audio/die.mp3') }}" type="audio/mpeg">
    </audio>

    <i class="fas fa-arrow-left back-btn" onclick="goBack()"></i>

    <div class="game-container">
        
        <!-- MENU SCREEN -->
        <div id="screen-menu" class="panel screen active">
            <button id="musicToggleBtn" onclick="toggleAudioSetting()" style="position: absolute; top: 30px; right: 30px; background: none; border: none; cursor: pointer; color: #ff9aa2; font-size: 2rem; z-index: 10; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                <i class="fas fa-volume-up"></i>
            </button>
            <div class="panel-header"><i class="fas fa-snake"></i> 贪吃蛇大作战</div>
            
            <!-- Mode Selection -->
            <div id="menu-modes" style="display: flex; flex-direction: column; align-items: center;">
                <button class="btn-anime" onclick="selectMode('1v1')">1 VS 1 对战</button>
                <button class="btn-anime" onclick="createGame('pve')">人机对战 (AI)</button>
                <button class="btn-anime" onclick="selectMode('3v3')">3 VS 3 团战</button>
                
                <div style="margin-top: 30px; display: flex; align-items: center;">
                    <input type="text" id="joinCodeInput" class="join-input" placeholder="输入房间号">
                    <button class="btn-anime" style="padding: 10px 20px; margin: 0;" onclick="joinGame()">加入房间</button>
                </div>
                
                <button class="btn-anime" style="margin-top: 30px; background: linear-gradient(45deg, #ffd1ff 0%, #fad0c4 100%); color: #555;" onclick="showLeaderboard()">排行榜</button>
            </div>

            <!-- Create Room Confirmation -->
            <div id="menu-create" style="display: none; flex-direction: column; align-items: center;">
                <h3 id="selectedModeTitle" style="color: #ff9a9e; margin-bottom: 30px; font-family: 'Fredoka One'; font-size: 2rem;">已选择: 1 VS 1</h3>
                <button class="btn-anime" onclick="confirmCreateGame()">创建房间</button>
                <button class="btn-anime" style="background: linear-gradient(to bottom, #eee, #ddd); color: #888; border-color: #fff;" onclick="cancelMode()">返回</button>
            </div>
        </div>

        <!-- LOBBY SCREEN -->
        <div id="screen-lobby" class="panel screen">
            <div class="panel-header">等待大厅</div>
            <div class="lobby-info">
                <span>房间号: <strong id="lobbyRoomCode" style="color: #ff9a9e; font-size: 1.5em;"></strong></span>
                <span id="lobbyType">模式: 1V1</span>
            </div>
            
            <div class="lobby-content">
                <div class="player-list" id="lobbyPlayerList">
                    <!-- Players go here -->
                </div>
                
                <div class="lobby-chat">
                    <div class="lobby-chat-msgs" id="lobbyChatMsgs">
                        <div style="color:#aaa; text-align:center; margin-top:10px;">- 聊天区域 -</div>
                    </div>
                    <div class="lobby-chat-input">
                        <input type="text" id="lobbyChatInput" placeholder="输入消息..." onkeypress="handleLobbyChat(event)">
                    </div>
                </div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="screen-game" class="screen" style="position: relative;">
            <div class="game-layout">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
                
                <div class="game-sidebar" style="display: flex; flex-direction: column; gap: 20px;">
                    <div class="scoreboard">
                        <h4 style="margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; color: #ff9a9e;">实时战况</h4>
                        <div id="scoreList"></div>
                    </div>

                    <div class="chat-overlay">
                        <div class="chat-messages" id="gameChatMsgs"></div>
                        <div class="chat-input">
                            <input type="text" id="gameChatInput" placeholder="按回车发送..." onkeypress="handleChat(event)">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Death Modal for 3v3 -->
            <div id="deathModal" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(255,255,255,0.95); padding:30px; border-radius:20px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.2); border:5px solid #ff9aa2; z-index:1000; min-width: 300px;">
                <h2 style="color:#ff6f91; font-family:'Fredoka One'; margin-bottom:20px; font-size: 2rem;">你挂了！(｡•́︿•̀｡)</h2>
                <div style="display:flex; gap:15px; justify-content:center;">
                    <button class="btn-anime" style="min-width:120px; padding:10px 20px; font-size:1rem; margin:0;" onclick="spectateGame()">留下观战</button>
                    <button class="btn-anime" style="min-width:120px; padding:10px 20px; font-size:1rem; margin:0; background:linear-gradient(to bottom, #ccc, #aaa); border-color:#eee;" onclick="goBack()">退出游戏</button>
                </div>
            </div>

            <!-- Countdown Overlay -->
            <div id="countdownOverlay" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); z-index:2000; pointer-events: none;">
                <div id="countdownText" style="font-family: 'Fredoka One', cursive; font-size: 8rem; color: #ff9aa2; text-shadow: 4px 4px 0px #fff, 8px 8px 0px rgba(0,0,0,0.1); animation: popCountdown 0.5s infinite alternate;">3</div>
            </div>
        </div>
        
        <!-- LEADERBOARD SCREEN -->
        <div id="screen-leaderboard" class="panel screen">
            <div class="panel-header" style="color: #ffbc00;">TOP 10 高手榜</div>
            <div class="player-list" id="leaderboardList" style="height: 400px;"></div>
            <button class="btn-anime" onclick="showScreen('screen-menu')">返回</button>
        </div>

    </div>

    <!-- 引入 Layui 和 JQuery (Layui 内置) -->
    <script src="/static/layui/layui-v2.13.3/layui/layui.js"></script>
    <script>
        // Global State
        let ws = null;
        let currentRoom = null;
        let myId = "{{ session.get('user_id') }}";
        let myNickname = "{{ session.get('nickname') }}";
        let gameState = { players: {}, food: [] };
        let canvas = document.getElementById('gameCanvas');
        let ctx = canvas.getContext('2d');
        let cellSize = 20; // 800/40 = 20
        let isOwner = false;
        let isDead = false;
        let isSpectating = false;
        let selectedMode = null;

        // Colors (Anime Style - Refined)
        const COLORS = {
            self: '#ff9aa2',    // Pastel Red/Pink
            enemy: '#c7ceea',   // Pastel Purple
            team1: '#ff9aa2',
            team2: '#c7ceea',
            food: '#ffdac1',    // Pastel Orange
            wall: '#b5ead7'     // Pastel Green
        };

        // Key Animation
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes popCountdown {
                from { transform: scale(1); }
                to { transform: scale(1.2); }
            }
        `;
        document.head.appendChild(styleSheet);

        // Audio System
        let isAudioEnabled = localStorage.getItem('snake_audio') !== 'false'; // Default true
        
        function updateAudioUI() {
            let btn = document.getElementById('musicToggleBtn');
            if (!btn) return;
            let icon = btn.querySelector('i');
            if(isAudioEnabled) {
                icon.className = 'fas fa-volume-up';
                btn.style.opacity = '1';
            } else {
                icon.className = 'fas fa-volume-mute';
                btn.style.opacity = '0.6';
            }
        }
        
        function toggleSettingsPanel() {
            let panel = document.getElementById('settingsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            updateAudioUI();
        }

        function toggleAudioSetting() {
            isAudioEnabled = !isAudioEnabled;
            localStorage.setItem('snake_audio', isAudioEnabled);
            updateAudioUI();
            
            // Apply immediately
            if(!isAudioEnabled) {
                stopAllBGM();
            } else {
                // Resume BGM based on current screen
                if(document.getElementById('screen-game').classList.contains('active') && !isSpectating && !isDead) {
                    playBGM('game');
                } else {
                    playBGM('menu');
                }
            }
        }

        function stopAllBGM() {
            let menuBgm = document.getElementById('bgm-menu');
            let gameBgm = document.getElementById('bgm-game');
            if(menuBgm) { menuBgm.pause(); menuBgm.currentTime = 0; }
            if(gameBgm) { gameBgm.pause(); gameBgm.currentTime = 0; }
        }

        function playBGM(type) {
            if(!isAudioEnabled) return;
            
            // Don't restart if already playing the same type
            let targetId = type === 'game' ? 'bgm-game' : 'bgm-menu';
            let targetAudio = document.getElementById(targetId);
            if(targetAudio && !targetAudio.paused) return;

            stopAllBGM();
            
            if(targetAudio) {
                let p = targetAudio.play();
                if(p !== undefined) {
                    p.catch(e => console.log("Auto-play prevented:", e));
                }
            }
        }

        function initAudio() {
            // Try to unlock audio context
            let sounds = ['bgm-menu', 'bgm-game', 'sfx-eat', 'sfx-die'];
            sounds.forEach(id => {
                let audio = document.getElementById(id);
                if(audio) {
                    audio.load();
                    // Just load to unlock on interaction
                    // We don't play/pause immediately to avoid sound artifacts
                    // The first real playBGM call will trigger it
                }
            });
            
            // Start Menu BGM if enabled
            if(isAudioEnabled) playBGM('menu');
        }

        // Navigation
        function selectMode(mode) {
            initAudio(); // Unlock on interaction
            selectedMode = mode;
            let title = mode === '1v1' ? '1 VS 1 对战' : '3 VS 3 团战';
            document.getElementById('selectedModeTitle').innerText = '已选择: ' + title;
            document.getElementById('menu-modes').style.display = 'none';
            document.getElementById('menu-create').style.display = 'flex';
        }

        function cancelMode() {
            selectedMode = null;
            document.getElementById('menu-create').style.display = 'none';
            document.getElementById('menu-modes').style.display = 'flex';
        }

        function confirmCreateGame() {
            if (selectedMode) {
                createGame(selectedMode);
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goBack() {
            if (ws) {
                ws.close();
                ws = null;
            }
            
            // Reset State
            isDead = false;
            isSpectating = false;
            document.getElementById('deathModal').style.display = 'none';

            // Remove event listener to prevent leaks
            document.removeEventListener('keydown', handleInput);
            
            if(document.getElementById('screen-menu').classList.contains('active')) {
                // If in menu-create sub-screen, go back to modes
                if (document.getElementById('menu-create').style.display !== 'none') {
                    cancelMode();
                    return;
                }

                try {
                    window.close(); // Close tab if at menu
                } catch(e) {
                    console.log("Cannot close window:", e);
                }
            } else {
                showScreen('screen-menu');
                playBGM('menu');
            }
        }

        // API Calls
        function createGame(type) {
            initAudio(); // Unlock audio
            layui.use(['layer', 'jquery'], function(){
                let $ = layui.$;
                let layer = layui.layer;
                let loadIndex = layer.load(1); // Loading spinner
                
                // Disable buttons
                $('.btn-anime').prop('disabled', true);

                $.ajax({
                    url: '/game/api/snake/create',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ type: type }),
                    timeout: 10000, // 10s timeout
                    success: function(res) {
                        layer.close(loadIndex);
                        $('.btn-anime').prop('disabled', false);
                        if (res.success) {
                            isOwner = true;
                            // Clear chat history for new room
                            document.getElementById('lobbyChatMsgs').innerHTML = '<div style="color:#aaa; text-align:center; margin-top:10px;">- 聊天区域 -</div>';
                            document.getElementById('gameChatMsgs').innerHTML = '';
                            connectWs(res.room_code);
                        } else {
                            layer.msg('创建失败: ' + res.message, {icon: 2});
                        }
                    },
                    error: function(xhr, status, error) {
                        layer.close(loadIndex);
                        $('.btn-anime').prop('disabled', false);
                        if(status === 'timeout') {
                            layer.msg('请求超时，请检查网络', {icon: 2});
                        } else {
                            layer.msg('请求失败: ' + (xhr.statusText || error), {icon: 2});
                        }
                    }
                });
            });
        }

        function joinGame(code) {
            initAudio(); // Unlock audio
            if (!code) code = document.getElementById('joinCodeInput').value;
            if (!code) {
                layui.layer.msg('请输入房间号');
                return;
            }
            isOwner = false;
            connectWs(code);
        }

        function showLeaderboard() {
            layui.use('jquery', function(){
                let $ = layui.$;
                $.get('/game/api/snake/leaderboard', function(res){
                    if(res.success) {
                        let html = '';
                        res.data.forEach((item, index) => {
                            let rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
                            let icon = index < 3 ? '<i class="fas fa-crown"></i> ' : '';
                            html += `
                                <div class="rank-item ${rankClass}">
                                    <span>${icon}No.${index+1} ${item.username}</span>
                                    <span>${item.score}分</span>
                                </div>
                            `;
                        });
                        $('#leaderboardList').html(html);
                        showScreen('screen-leaderboard');
                    }
                });
            });
        }

        // WebSocket
        function connectWs(code) {
            // Clear previous chat history for EVERYONE joining or creating a new session
            document.getElementById('lobbyChatMsgs').innerHTML = '<div style="color:#aaa; text-align:center; margin-top:10px;">- 聊天区域 -</div>';
            document.getElementById('gameChatMsgs').innerHTML = '';

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/game/snake`);

            ws.onopen = () => {
                ws.send(JSON.stringify({ type: 'join', code: code }));
                currentRoom = code;
                document.getElementById('lobbyRoomCode').innerText = code;
                showScreen('screen-lobby');
            };

            ws.onmessage = (event) => {
                let msg = JSON.parse(event.data);
                
                if (msg.type === 'error') {
                    layui.layer.msg(msg.message);
                    goBack();
                } else if (msg.type === 'countdown') {
                    // Show Countdown Overlay
                    let overlay = document.getElementById('countdownOverlay');
                    let text = document.getElementById('countdownText');
                    
                    if (msg.count === 0) {
                        overlay.style.display = 'none';
                        playBGM('game');
                    } else {
                        overlay.style.display = 'block';
                        text.innerText = msg.count;
                    }
                } else if (msg.type === 'state') {
                    updateLobby(msg);
                    if (msg.status === 'playing') {
                        if (!document.getElementById('screen-game').classList.contains('active')) {
                            startGameUI();
                        }
                        gameState = msg;
                        renderGame();

                        // Check Death (3v3)
                        if (msg.mode === '3v3') {
                             let me = msg.players[myId];
                             if (me && !me.alive && !isDead && !isSpectating) {
                                 isDead = true;
                                 document.getElementById('deathModal').style.display = 'block';
                             }
                        }
                    }
                } else if (msg.type === 'chat') {
                    appendChat(msg);
                } else if (msg.type === 'lobby_chat') {
                    appendLobbyChat(msg);
                } else if (msg.type === 'game_over') {
                    layui.layer.alert(`游戏结束！获胜者: ${msg.winner.name}`, {
                        icon: 1,
                        end: () => goBack()
                    });
                }
            };

            ws.onclose = () => {
                // layui.layer.msg('连接断开');
            };
        }

        function updateLobby(msg) {
            let list = document.getElementById('lobbyPlayerList');
            list.innerHTML = '';
            
            // Update Type
            if (msg.mode) {
                let modeName = msg.mode === 'pve' ? '人机对战' : (msg.mode === '3v3' ? '3 VS 3' : '1 VS 1');
                document.getElementById('lobbyType').innerText = '模式: ' + modeName;
            }

            // Update List
            Object.entries(msg.players).forEach(([uid, p]) => {
                let item = document.createElement('div');
                item.className = 'player-item';
                
                // Owner Badge
                let ownerBadge = (uid == msg.owner_id) ? '<span style="background:#ff9aa2; color:white; padding:2px 8px; border-radius:10px; font-size:0.7em; margin-left:8px; vertical-align: middle;">房主</span>' : '';

                item.innerHTML = `
                    <img src="${p.avatar || '/static/images/default_avatar.svg'}">
                    <div>
                        <div style="font-weight:bold; display: flex; align-items: center;">${p.nickname} ${ownerBadge}</div>
                        <div style="font-size:0.8em; color:#aaa">TEAM ${p.team}</div>
                    </div>
                `;
                list.appendChild(item);
            });

            // Owner controls
            let controlDiv = document.createElement('div');
            controlDiv.style.marginTop = '20px';
            controlDiv.style.textAlign = 'center';
            controlDiv.style.width = '100%';

            if (isOwner) {
                let btn = document.createElement('button');
                btn.className = 'btn-anime';
                btn.onclick = startGame;
                
                // Check Player Count logic
                let playerCount = Object.keys(msg.players).filter(k => k !== 'ai').length;
                let required = (msg.mode === '3v3') ? 6 : (msg.mode === '1v1' ? 2 : 1);
                
                if (msg.mode !== 'pve' && playerCount < required) {
                    btn.innerText = `等待加入 (${playerCount}/${required})`;
                    btn.disabled = true;
                    btn.style.background = '#e0e0e0';
                    btn.style.borderColor = '#ccc';
                    btn.style.color = '#999';
                    btn.style.boxShadow = 'none';
                    btn.style.cursor = 'not-allowed';
                    btn.style.top = '0'; // Reset active state
                } else {
                    btn.innerText = '开始游戏';
                }

                controlDiv.appendChild(btn);
            } else {
                let p = document.createElement('p');
                p.style.color = '#888';
                p.innerText = '等待房主开始...';
                controlDiv.appendChild(p);
            }
            list.appendChild(controlDiv);
        }

        function startGame() {
            initAudio(); // Ensure unlocked before start
            if (ws) ws.send(JSON.stringify({ type: 'start' }));
        }

        function spectateGame() {
            document.getElementById('deathModal').style.display = 'none';
            isSpectating = true;
        }

        function startGameUI() {
            showScreen('screen-game');
            playBGM('game'); // Ensure BGM plays (reconnection or start)
            
            // Add key listener
            document.addEventListener('keydown', handleInput);
        }

        function handleInput(e) {
            let dir = null;
            if (e.key === 'ArrowUp' || e.key === 'w') dir = 'up';
            else if (e.key === 'ArrowDown' || e.key === 's') dir = 'down';
            else if (e.key === 'ArrowLeft' || e.key === 'a') dir = 'left';
            else if (e.key === 'ArrowRight' || e.key === 'd') dir = 'right';
            
            if (dir && ws) {
                ws.send(JSON.stringify({ type: 'input', direction: dir }));
            }
        }

        function handleChat(e) {
            if (e.key === 'Enter') {
                let input = document.getElementById('gameChatInput');
                let content = input.value.trim();
                if (content && ws) {
                    ws.send(JSON.stringify({ type: 'chat', content: content }));
                    input.value = '';
                }
            }
        }

        function handleLobbyChat(e) {
            if (e.key === 'Enter') {
                let input = document.getElementById('lobbyChatInput');
                let content = input.value.trim();
                if (content && ws) {
                    ws.send(JSON.stringify({ type: 'chat', content: content }));
                    input.value = '';
                }
            }
        }

        function appendChat(msg) {
            // Append to Game Chat
            let divGame = document.getElementById('gameChatMsgs');
            if (divGame) {
                let p = document.createElement('div');
                p.style.marginBottom = '5px';
                p.innerHTML = `<span style="color:#ff9aa2">${msg.user}:</span> ${msg.content}`;
                divGame.appendChild(p);
                divGame.scrollTop = divGame.scrollHeight;
            }

            // Append to Lobby Chat (if active or just background update)
            let divLobby = document.getElementById('lobbyChatMsgs');
            if (divLobby) {
                let p = document.createElement('div');
                p.style.marginBottom = '5px';
                p.innerHTML = `<span style="color:#ff9aa2">${msg.user}:</span> ${msg.content}`;
                divLobby.appendChild(p);
                divLobby.scrollTop = divLobby.scrollHeight;
            }
        }

        // Render Loop
        function renderGame() {
            // Clear - White/Paper background
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw Grid (Light dotted/dashed)
            ctx.strokeStyle = '#eee';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]); // Dashed lines
            for(let i=0; i<canvas.width; i+=cellSize) {
                ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, canvas.height); ctx.stroke();
            }
            for(let i=0; i<canvas.height; i+=cellSize) {
                ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width, i); ctx.stroke();
            }
            ctx.setLineDash([]); // Reset

            // Draw Food (Circle with glow)
            gameState.food.forEach(f => {
                ctx.fillStyle = COLORS.food;
                ctx.beginPath();
                ctx.arc(f.x * cellSize + cellSize/2, f.y * cellSize + cellSize/2, cellSize/2 - 2, 0, Math.PI*2);
                ctx.fill();
                
                // Shine/Reflection
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.beginPath();
                ctx.arc(f.x * cellSize + cellSize/3, f.y * cellSize + cellSize/3, cellSize/6, 0, Math.PI*2);
                ctx.fill();
                
                // Glow
                ctx.shadowBlur = 15;
                ctx.shadowColor = COLORS.food;
            });
            ctx.shadowBlur = 0;

            // Draw Players (Rounded)
            Object.entries(gameState.players).forEach(([uid, p]) => {
                if (!p.alive) return;
                
                // Color Logic
                let color = COLORS.enemy;
                if (uid == myId) color = COLORS.self;
                else if (gameState.players[myId] && p.team == gameState.players[myId].team) color = COLORS.team1;
                
                ctx.fillStyle = color;
                
                // Head (Circle)
                ctx.beginPath();
                ctx.arc(p.x * cellSize + cellSize/2, p.y * cellSize + cellSize/2, cellSize/2, 0, Math.PI*2);
                ctx.fill();
                
                // Eyes (Cute)
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(p.x * cellSize + cellSize/3, p.y * cellSize + cellSize/3, 4, 0, Math.PI*2); // Left Eye
                ctx.arc(p.x * cellSize + cellSize*2/3, p.y * cellSize + cellSize/3, 4, 0, Math.PI*2); // Right Eye
                ctx.fill();
                
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.arc(p.x * cellSize + cellSize/3, p.y * cellSize + cellSize/3, 2, 0, Math.PI*2); // Left Pupil
                ctx.arc(p.x * cellSize + cellSize*2/3, p.y * cellSize + cellSize/3, 2, 0, Math.PI*2); // Right Pupil
                ctx.fill();

                // Restore body color
                ctx.fillStyle = color;

                // Body (Circles)
                p.body.forEach(b => {
                    ctx.beginPath();
                    ctx.arc(b.x * cellSize + cellSize/2, b.y * cellSize + cellSize/2, cellSize/2 - 1, 0, Math.PI*2);
                    ctx.fill();
                });
                
                // Name
                ctx.fillStyle = '#555';
                if (gameState.mode === '3v3') {
                    // Team 1: Blue, Team 2: Red
                    ctx.fillStyle = (p.team === 1) ? '#00d2ff' : '#ff4d4d';
                }
                ctx.font = 'bold 12px "Varela Round", Arial';
                ctx.textAlign = 'center';
                
                let displayName = p.nickname;
                if (uid == myId) {
                    displayName += " (我)";
                    // Optional: Highlight self name differently if needed, 
                    // but keeping consistent with team color is usually better.
                    // If not 3v3, maybe make self bold or colored?
                    if (gameState.mode !== '3v3') {
                         ctx.fillStyle = '#ff9aa2'; // Match self snake color
                    }
                }
                
                ctx.fillText(displayName, p.x * cellSize + cellSize/2, p.y * cellSize - 8);
            });

            // Update Scoreboard
            let html = '';
            // Sort by score
            let sortedPlayers = Object.values(gameState.players).sort((a,b) => b.score - a.score);
            sortedPlayers.forEach(p => {
                let color = (p.team === 1) ? '#00d2ff' : '#ff4d4d';
                html += `<div style="display:flex; justify-content:space-between; color:${color}; margin-bottom:5px;">
                            <span>${p.nickname}</span>
                            <span>${p.score}</span>
                         </div>`;
            });
            document.getElementById('scoreList').innerHTML = html;
        }

        // Initialize Audio UI
        updateAudioUI();
    </script>
</body>
</html>

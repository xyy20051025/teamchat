{% extends "admin/base.html" %}

{% block content %}
<style>
/* Sci-Fi Theme Overrides */
:root {
    --neon-blue: #00f3ff;
    --neon-purple: #bc13fe;
    --dark-bg: #0b0c15;
    --card-bg: rgba(20, 20, 35, 0.8);
    --text-color: #e0e0e0;
}

/* Override body background for this page specifically if possible, 
   but since it extends base, we apply style to the content wrapper */
.layui-fluid {
    min-height: 100vh;
    background-color: var(--dark-bg);
    background-image: 
        linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
    background-size: 20px 20px;
    color: var(--text-color);
}

.scifi-card {
    background: var(--card-bg);
    border: 1px solid rgba(0, 243, 255, 0.2);
    box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
    color: var(--text-color);
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    height: 100%;
}

.scifi-card:hover {
    border-color: var(--neon-blue);
    box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
    transform: translateY(-2px);
}

.scifi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
    opacity: 0.7;
}

.scifi-header {
    padding: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0, 0, 0, 0.2);
}

.scifi-title {
    font-size: 18px;
    font-weight: bold;
    color: var(--neon-blue);
    text-shadow: 0 0 5px rgba(0, 243, 255, 0.5);
    letter-spacing: 1px;
}

.scifi-body {
    padding: 15px;
    font-size: 14px;
    line-height: 1.6;
}

.scifi-label {
    color: rgba(255, 255, 255, 0.6);
    display: inline-block;
    width: 80px;
}

.scifi-value {
    color: #fff;
    font-family: 'Consolas', monospace;
    word-break: break-all;
}

.scifi-badge {
    background: rgba(0, 243, 255, 0.1);
    border: 1px solid var(--neon-blue);
    color: var(--neon-blue);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.scifi-btn {
    background: transparent;
    border: 1px solid var(--neon-blue);
    color: var(--neon-blue);
    transition: all 0.3s;
}

.scifi-btn:hover {
    background: var(--neon-blue);
    color: #000;
    box-shadow: 0 0 15px var(--neon-blue);
}

.scifi-btn-danger {
    border-color: #ff3366;
    color: #ff3366;
}

.scifi-btn-danger:hover {
    background: #ff3366;
    color: #fff;
    box-shadow: 0 0 15px #ff3366;
}
</style>

<div class="layui-fluid" style="padding: 20px;">
    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="color: var(--neon-blue); text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); font-weight: bold; letter-spacing: 2px;">
            <i class="layui-icon layui-icon-app"></i> 第三方接口管理
        </h2>
        <button class="layui-btn scifi-btn" onclick="openInterfaceForm()">
            <i class="layui-icon layui-icon-add-1"></i> 新增接口
        </button>
    </div>

    <div class="layui-row layui-col-space20" id="interfaceContainer">
        <!-- Cards rendered here -->
    </div>
    
    <div id="pagination" style="text-align: center; margin-top: 30px;"></div>
</div>

<!-- Template -->
<script type="text/html" id="interfaceCardTpl">
    {% raw %}
    {{#  layui.each(d.data, function(index, item){ }}
    <div class="layui-col-md6">
        <div class="scifi-card">
            <div class="scifi-header">
                <span class="scifi-title">{{ item.name }}</span>
                <div class="layui-form">
                    <div class="layui-unselect layui-form-switch btn-toggle-switch {{ item.is_active ? 'layui-form-onswitch' : '' }}" 
                         style="margin-top: 0;"
                         data-id="{{ item.id }}">
                        <i></i>
                    </div>
                </div>
            </div>
            <div class="scifi-body">
                <div style="display: flex; justify-content: space-between;">
                    <div style="flex: 1; padding-right: 10px;">
                        <p><span class="scifi-label">调用指令:</span> <span class="scifi-value">{{ item.command }}</span></p>
                        <p><span class="scifi-label">接口地址:</span> <span class="scifi-value">{{ item.api_url }}</span></p>
                        <p><span class="scifi-label">Token:</span> <span class="scifi-value" style="color: var(--neon-purple)">{{ item.api_token ? '已设置' : '未设置' }}</span></p>
                    </div>
                    <div style="text-align: right; min-width: 100px;">
                        <span class="scifi-badge">{{ item.created_at }}</span>
                    </div>
                </div>
                <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
                <div style="text-align: right;">
                    <button class="layui-btn layui-btn-xs scifi-btn btn-edit-interface" data-index="{{ index }}">
                        <i class="layui-icon layui-icon-edit"></i> 编辑
                    </button>
                    <button class="layui-btn layui-btn-xs scifi-btn scifi-btn-danger btn-delete-interface" data-id="{{ item.id }}">
                        <i class="layui-icon layui-icon-delete"></i> 删除
                    </button>
                </div>
            </div>
        </div>
    </div>
    {{#  }); }}
    {{#  if(d.data.length === 0){ }}
    <div class="layui-col-md12" style="text-align: center; color: rgba(255,255,255,0.3); padding: 50px;">
        <i class="layui-icon layui-icon-app" style="font-size: 50px; margin-bottom: 20px;"></i>
        <p>暂无第三方接口</p>
    </div>
    {{#  } }}
    {% endraw %}
</script>

<!-- Add/Edit Form -->
<div id="interfaceForm" style="display: none; padding: 20px;">
    <form class="layui-form" lay-filter="interfaceFormFilter" style="color: #fff;">
        <input type="hidden" name="id">
        <div class="layui-form-item">
            <label class="layui-form-label" style="color: #ccc;">接口名称</label>
            <div class="layui-input-block">
                <input type="text" name="name" required lay-verify="required" placeholder="如：天气查询" class="layui-input" style="background: rgba(0,0,0,0.3); color: #fff; border-color: #444;">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="color: #ccc;">调用指令</label>
            <div class="layui-input-block">
                <input type="text" name="command" required lay-verify="required" placeholder="如：@天气" class="layui-input" style="background: rgba(0,0,0,0.3); color: #fff; border-color: #444;">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="color: #ccc;">接口地址</label>
            <div class="layui-input-block">
                <input type="text" name="api_url" required lay-verify="required" placeholder="如：https://api.example.com/weather" class="layui-input" style="background: rgba(0,0,0,0.3); color: #fff; border-color: #444;">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="color: #ccc;">接口Token</label>
            <div class="layui-input-block">
                <input type="text" name="api_token" placeholder="可选填" class="layui-input" style="background: rgba(0,0,0,0.3); color: #fff; border-color: #444;">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn scifi-btn" lay-submit lay-filter="saveInterface">保存</button>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
layui.use(['laypage', 'layer', 'laytpl', 'form'], function(){
    var laypage = layui.laypage;
    var layer = layui.layer;
    var laytpl = layui.laytpl;
    var form = layui.form;
    var $ = layui.$;
    
    var limit = 6;
    window.currentInterfaceList = [];

    window.loadInterfaces = function(page) {
        $.getJSON('{{ url_for("backend.get_interfaces") }}', {page: page, limit: limit}, function(res){
            if(res.code === 0){
                window.currentInterfaceList = res.data;
                var getTpl = document.getElementById('interfaceCardTpl').innerHTML;
                laytpl(getTpl).render(res, function(html){
                    document.getElementById('interfaceContainer').innerHTML = html;
                });
                
                laypage.render({
                    elem: 'pagination',
                    count: res.count,
                    limit: limit,
                    curr: page,
                    theme: '#00f3ff',
                    jump: function(obj, first){
                        if(!first){
                            loadInterfaces(obj.curr);
                        }
                    }
                });
            }
        });
    }
    
    // Event Delegation
    $(document).on('click', '.btn-toggle-switch', function() {
        var $div = $(this);
        var id = $div.data('id');
        var is_active = !$div.hasClass('layui-form-onswitch');
        
        if(is_active) {
            $div.addClass('layui-form-onswitch');
        } else {
            $div.removeClass('layui-form-onswitch');
        }
        
        $.ajax({
            url: '{{ url_for("backend.toggle_interface") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({id: id, is_active: is_active}),
            success: function(res) {
                if(!res.success) layer.msg('操作失败');
            }
        });
    });

    $(document).on('click', '.btn-edit-interface', function() {
        var index = $(this).data('index');
        editInterfaceByIndex(index);
    });

    $(document).on('click', '.btn-delete-interface', function() {
        var id = $(this).data('id');
        deleteInterface(id);
    });

    window.editInterfaceByIndex = function(index) {
        if(window.currentInterfaceList && window.currentInterfaceList[index]) {
            openInterfaceForm(window.currentInterfaceList[index]);
        }
    }

    window.openInterfaceForm = function(data) {
        $('input[name="id"]').val('');
        $('#interfaceForm form')[0].reset();
        
        if(data) {
            form.val('interfaceFormFilter', data);
        }
        
        layer.open({
            type: 1,
            title: data ? '编辑接口' : '新增接口',
            area: ['600px', '450px'],
            content: $('#interfaceForm'),
            shade: 0.8,
            success: function(layero, index){
                layero.find('.layui-layer-title').css({
                    'background': '#111', 
                    'color': 'var(--neon-blue)', 
                    'border-bottom': '1px solid #333'
                });
                layero.find('.layui-layer-content').css('background', '#1a1a2e');
            }
        });
    }
    
    form.on('submit(saveInterface)', function(data){
        $.ajax({
            url: '{{ url_for("backend.save_interface") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data.field),
            success: function(res) {
                if(res.success) {
                    layer.closeAll();
                    layer.msg('保存成功', {icon: 1});
                    loadInterfaces(1);
                } else {
                    layer.msg(res.message, {icon: 2});
                }
            }
        });
        return false;
    });
    
    window.deleteInterface = function(id) {
        layer.confirm('确定要删除该接口吗？', {
            title: '警告',
            btn: ['确认删除', '取消']
        }, function(index){
            $.ajax({
                url: '{{ url_for("backend.delete_interface") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({id: id}),
                success: function(res) {
                    if(res.success) {
                        layer.msg('已删除');
                        loadInterfaces(1);
                    } else {
                        layer.msg(res.message, {icon: 2});
                    }
                }
            });
            layer.close(index);
        });
    }
    
    loadInterfaces(1);
});
</script>
{% endblock %}
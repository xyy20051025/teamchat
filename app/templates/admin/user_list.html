{% extends "admin/base.html" %}

{% block content %}
<div class="layui-card">
    <div class="layui-card-header">用户管理</div>
    <div class="layui-card-body">
        <table id="userTable" lay-filter="userTable"></table>
    </div>
</div>

<script type="text/html" id="barDemo">
    {% raw %}
    {{#  if(d.username == '趣冰'){ }}
        <span class="layui-badge layui-bg-gray">系统AI用户</span>
    {{#  } else { }}
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        {{#  if(d.is_banned){ }}
            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="unban">解封</a>
        {{#  } else { }}
            <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="ban">封禁</a>
        {{#  } }}
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    {{#  } }}
    {% endraw %}
</script>

<script type="text/html" id="statusTpl">
    {% raw %}
    {{#  if(d.is_banned){ }}
        <span style="color: #FF5722;">已封禁</span>
    {{#  } else { }}
        <span style="color: #009688;">正常</span>
    {{#  } }}
    {% endraw %}
</script>
{% endblock %}

{% block scripts %}
<script>
layui.use(['table', 'layer', 'form'], function(){
    var table = layui.table;
    var layer = layui.layer;
    var form = layui.form;
    
    //渲染表格
    table.render({
        elem: '#userTable',
        url: '{{ url_for("backend.get_users") }}', // 数据接口
        page: { limit: 20 }, // 开启分页
        cols: [[ // 表头
            {field: 'id', title: 'ID', width: 80, sort: true, fixed: 'left'},
            {field: 'username', title: '用户名', width: 150},
            {field: 'nickname', title: '昵称', width: 150},
            {field: 'user_code', title: '编码', width: 100},
            {field: 'is_banned', title: '状态', width: 100, templet: '#statusTpl'},
            {field: 'created_at', title: '注册时间', width: 160},
            {fixed: 'right', title:'操作', toolbar: '#barDemo', width: 200}
        ]]
    });
    
    //监听工具条
    table.on('tool(userTable)', function(obj){
        var data = obj.data;
        if(obj.event === 'del'){
            layer.confirm('真的删除用户 ' + data.username + ' 吗？', function(index){
                // 向服务端发送删除指令
                fetch('{{ url_for("backend.delete_user") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: data.id})
                })
                .then(response => response.json())
                .then(res => {
                    if(res.success){
                        obj.del();
                        layer.close(index);
                        layer.msg('删除成功');
                    } else {
                        layer.msg(res.message);
                    }
                });
            });
        } else if(obj.event === 'ban'){
            layer.confirm('确认封禁该用户？', function(index){
                updateStatus(data.id, true);
            });
        } else if(obj.event === 'unban'){
            layer.confirm('确认解封该用户？', function(index){
                updateStatus(data.id, false);
            });
        } else if(obj.event === 'edit'){
            // 编辑逻辑，可以使用 layer.open 打开弹窗
            layer.open({
                type: 1,
                title: '编辑用户',
                area: ['500px', '400px'],
                content: `
                    <div style="padding: 20px;">
                        <form class="layui-form" lay-filter="editForm">
                            <input type="hidden" name="id" value="${data.id}">
                            <div class="layui-form-item">
                                <label class="layui-form-label">昵称</label>
                                <div class="layui-input-block">
                                    <input type="text" name="nickname" value="${data.nickname || ''}" required  lay-verify="required" placeholder="请输入昵称" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">密码</label>
                                <div class="layui-input-block">
                                    <input type="password" name="password" placeholder="留空不修改" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <button class="layui-btn" lay-submit lay-filter="editSubmit">立即提交</button>
                                </div>
                            </div>
                        </form>
                    </div>
                `,
                success: function(layero, index){
                    form.render();
                    form.on('submit(editSubmit)', function(formData){
                        fetch('{{ url_for("backend.update_user") }}', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(formData.field)
                        })
                        .then(response => response.json())
                        .then(res => {
                            if(res.success){
                                layer.close(index);
                                layer.msg('更新成功');
                                table.reload('userTable');
                            } else {
                                layer.msg(res.message);
                            }
                        });
                        return false;
                    });
                }
            });
        }
    });
    
    function updateStatus(id, ban){
        fetch('{{ url_for("backend.ban_user") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: id, ban: ban})
        })
        .then(response => response.json())
        .then(res => {
            if(res.success){
                layer.msg('操作成功');
                table.reload('userTable');
            } else {
                layer.msg(res.message);
            }
        });
    }
});
</script>
{% endblock %}
{% extends "admin/base.html" %}

{% block content %}
<style>
/* Sci-Fi Theme Overrides */
:root {
    --neon-blue: #00f3ff;
    --neon-purple: #bc13fe;
    --dark-bg: #0b0c15;
    --card-bg: rgba(20, 20, 35, 0.8);
    --text-color: #e0e0e0;
}

/* Override body background for this page specifically if possible, 
   but since it extends base, we apply style to the content wrapper */
.layui-fluid {
    min-height: 100vh;
    background-color: var(--dark-bg);
    background-image: 
        linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
    background-size: 20px 20px;
    color: var(--text-color);
}

.scifi-card {
    background: var(--card-bg);
    border: 1px solid rgba(0, 243, 255, 0.2);
    box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
    color: var(--text-color);
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    height: 100%;
}

.scifi-card:hover {
    border-color: var(--neon-blue);
    box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
    transform: translateY(-2px);
}

.scifi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
    opacity: 0.7;
}

.scifi-header {
    padding: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0, 0, 0, 0.2);
}

.scifi-title {
    font-size: 18px;
    font-weight: bold;
    color: var(--neon-blue);
    text-shadow: 0 0 5px rgba(0, 243, 255, 0.5);
    letter-spacing: 1px;
}

.scifi-body {
    padding: 15px;
    font-size: 14px;
    line-height: 1.6;
}

.scifi-label {
    color: rgba(255, 255, 255, 0.6);
    display: inline-block;
    width: 80px;
}

.scifi-value {
    color: #fff;
    font-family: 'Consolas', monospace;
    word-break: break-all;
}

.scifi-badge {
    background: rgba(0, 243, 255, 0.1);
    border: 1px solid var(--neon-blue);
    color: var(--neon-blue);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.scifi-btn {
    background: transparent;
    border: 1px solid var(--neon-blue);
    color: var(--neon-blue);
    transition: all 0.3s;
}

.scifi-btn:hover {
    background: var(--neon-blue);
    color: #000;
    box-shadow: 0 0 15px var(--neon-blue);
}

.scifi-btn-danger {
    border-color: #ff3366;
    color: #ff3366;
}

.scifi-btn-danger:hover {
    background: #ff3366;
    color: #fff;
    box-shadow: 0 0 15px #ff3366;
}

/* Chat Modal Styles */
#chatBox {
    height: 300px;
    overflow-y: auto;
    padding: 15px;
    background: #000;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 15px;
    font-family: 'Consolas', monospace;
}

.chat-msg {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 4px;
    max-width: 80%;
    word-wrap: break-word;
}

.chat-msg.user {
    background: rgba(0, 243, 255, 0.15);
    border-left: 2px solid var(--neon-blue);
    margin-left: auto;
    color: #fff;
}

.chat-msg.ai {
    background: rgba(188, 19, 254, 0.15);
    border-left: 2px solid var(--neon-purple);
    margin-right: auto;
    color: #fff;
}
</style>

<div class="layui-fluid" style="padding: 20px;">
    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="color: var(--neon-blue); text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); font-weight: bold; letter-spacing: 2px;">
            <i class="layui-icon layui-icon-engine"></i> AI MODEL ENGINE
        </h2>
        <button class="layui-btn scifi-btn" onclick="openModelForm()">
            <i class="layui-icon layui-icon-add-1"></i> 接入新模型
        </button>
    </div>

    <div class="layui-row layui-col-space20" id="modelContainer">
        <!-- Cards rendered here -->
    </div>
    
    <div id="pagination" style="text-align: center; margin-top: 30px;"></div>
</div>

<!-- Template -->
<script type="text/html" id="modelCardTpl">
    {% raw %}
    {{#  layui.each(d.data, function(index, item){ }}
    <div class="layui-col-md6">
        <div class="scifi-card">
            <div class="scifi-header">
                <span class="scifi-title">{{ item.name }}</span>
                {{# if(item.is_default){ }}
                <span class="layui-badge layui-bg-orange" style="margin-left: 10px; background-color: #ffb800 !important; color: #000;">默认</span>
                {{# } }}
                <div class="layui-form">
                    <!-- Simulate switch with custom handling -->
                    <div class="layui-unselect layui-form-switch btn-toggle-switch {{ item.is_active ? 'layui-form-onswitch' : '' }}" 
                         style="margin-top: 0;"
                         data-id="{{ item.id }}">
                        <i></i>
                    </div>
                </div>
            </div>
            <div class="scifi-body">
                <div style="display: flex; justify-content: space-between;">
                    <div style="flex: 1; padding-right: 10px;">
                        <p><span class="scifi-label">模型ID:</span> <span class="scifi-value">{{ item.model_name }}</span></p>
                        <p><span class="scifi-label">API接入:</span> <span class="scifi-value">{{ item.api_url }}</span></p>
                        <p><span class="scifi-label">Token:</span> <span class="scifi-value" style="color: var(--neon-purple)">{{ item.token_usage }}</span></p>
                    </div>
                    <div style="text-align: right; min-width: 100px;">
                        <span class="scifi-badge">{{ item.created_at }}</span>
                    </div>
                </div>
                <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
                <div style="text-align: right;">
                    {{# if(!item.is_default && item.is_active){ }}
                    <button class="layui-btn layui-btn-xs scifi-btn btn-set-default" data-id="{{ item.id }}" style="border-color: #ffb800; color: #ffb800;">
                        <i class="layui-icon layui-icon-star"></i> 设为默认
                    </button>
                    {{# } }}
                    <button class="layui-btn layui-btn-xs scifi-btn btn-test-model" data-id="{{ item.id }}" data-name="{{ item.name }}">
                        <i class="layui-icon layui-icon-dialogue"></i> 测试连接
                    </button>
                    <button class="layui-btn layui-btn-xs scifi-btn btn-edit-model" data-index="{{ index }}">
                        <i class="layui-icon layui-icon-edit"></i> 配置
                    </button>
                    <button class="layui-btn layui-btn-xs scifi-btn scifi-btn-danger btn-delete-model" data-id="{{ item.id }}">
                        <i class="layui-icon layui-icon-delete"></i> 卸载
                    </button>
                </div>
            </div>
        </div>
    </div>
    {{#  }); }}
    {{#  if(d.data.length === 0){ }}
    <div class="layui-col-md12" style="text-align: center; color: rgba(255,255,255,0.3); padding: 50px;">
        <i class="layui-icon layui-icon-engine" style="font-size: 50px; margin-bottom: 20px;"></i>
        <p>暂无AI模型引擎接入</p>
    </div>
    {{#  } }}
    {% endraw %}
</script>

<!-- Add/Edit Form -->
<div id="modelForm" style="display: none; padding: 20px;">
    <form class="layui-form" lay-filter="modelFormFilter" style="color: #fff;">
        <input type="hidden" name="id">
        <div class="layui-form-item">
            <label class="layui-form-label" style="color: #ccc;">引擎名称</label>
            <div class="layui-input-block">
                <input type="text" name="name" required lay-verify="required" placeholder="如：DeepSeek-V3" class="layui-input" style="background: rgba(0,0,0,0.3); color: #fff; border-color: #444;">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="color: #ccc;">API地址</label>
            <div class="layui-input-block">
                <input type="text" name="api_url" required lay-verify="required" placeholder="如：https://api.siliconflow.cn/v1" class="layui-input" style="background: rgba(0,0,0,0.3); color: #fff; border-color: #444;">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="color: #ccc;">API Key</label>
            <div class="layui-input-block">
                <input type="password" name="api_key" required lay-verify="required" placeholder="sk-..." class="layui-input" style="background: rgba(0,0,0,0.3); color: #fff; border-color: #444;">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="color: #ccc;">模型ID</label>
            <div class="layui-input-block">
                <input type="text" name="model_name" required lay-verify="required" placeholder="如：deepseek-ai/DeepSeek-V3" class="layui-input" style="background: rgba(0,0,0,0.3); color: #fff; border-color: #444;">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="color: #ccc;">提示词</label>
            <div class="layui-input-block">
                <textarea name="prompt" placeholder="系统预设提示词 (System Prompt)" class="layui-textarea" style="background: rgba(0,0,0,0.3); color: #fff; border-color: #444;"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn scifi-btn" lay-submit lay-filter="saveModel">保存接入</button>
            </div>
        </div>
    </form>
</div>

<!-- Test Chat Modal -->
<div id="testModal" style="display: none; padding: 15px;">
    <div id="chatBox"></div>
    <div style="display: flex; gap: 10px;">
        <input type="text" id="testInput" class="layui-input" placeholder="输入测试消息..." style="background: #222; color: #fff; border-color: #444;">
        <button class="layui-btn scifi-btn" onclick="sendTestMsg()">发送</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
layui.use(['laypage', 'layer', 'laytpl', 'form'], function(){
    var laypage = layui.laypage;
    var layer = layui.layer;
    var laytpl = layui.laytpl;
    var form = layui.form;
    var $ = layui.$;
    
    var limit = 6;
    var currentTestId = null;
    window.currentModelList = [];

    window.loadModels = function(page) {
        $.getJSON('{{ url_for("backend.get_ai_models") }}', {page: page, limit: limit}, function(res){
            if(res.code === 0){
                window.currentModelList = res.data;
                var getTpl = document.getElementById('modelCardTpl').innerHTML;
                laytpl(getTpl).render(res, function(html){
                    document.getElementById('modelContainer').innerHTML = html;
                });
                
                laypage.render({
                    elem: 'pagination',
                    count: res.count,
                    limit: limit,
                    curr: page,
                    theme: '#00f3ff',
                    jump: function(obj, first){
                        if(!first){
                            loadModels(obj.curr);
                        }
                    }
                });
            }
        });
    }
    
    // Event Delegation
    $(document).on('click', '.btn-toggle-switch', function() {
        var $div = $(this);
        var id = $div.data('id');
        var is_active = !$div.hasClass('layui-form-onswitch');
        
        if(is_active) {
            $div.addClass('layui-form-onswitch');
        } else {
            $div.removeClass('layui-form-onswitch');
        }
        
        $.ajax({
            url: '{{ url_for("backend.toggle_ai_model") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({id: id, is_active: is_active}),
            success: function(res) {
                if(!res.success) layer.msg('操作失败');
                else loadModels(1); // Reload to update set-default buttons visibility
            }
        });
    });

    $(document).on('click', '.btn-set-default', function() {
        var id = $(this).data('id');
        $.ajax({
            url: '{{ url_for("backend.set_default_ai_model") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({id: id}),
            success: function(res) {
                if(res.success) {
                    layer.msg('已设为默认');
                    loadModels(1);
                } else {
                    layer.msg(res.message);
                }
            }
        });
    });

    $(document).on('click', '.btn-test-model', function() {
        var id = $(this).data('id');
        var name = $(this).data('name');
        testModel(id, name);
    });

    $(document).on('click', '.btn-edit-model', function() {
        var index = $(this).data('index');
        editModelByIndex(index);
    });

    $(document).on('click', '.btn-delete-model', function() {
        var id = $(this).data('id');
        deleteModel(id);
    });

    window.editModelByIndex = function(index) {
        if(window.currentModelList && window.currentModelList[index]) {
            openModelForm(window.currentModelList[index]);
        }
    }

    window.openModelForm = function(data) {
        $('input[name="id"]').val('');
        $('#modelForm form')[0].reset();
        
        if(data) {
            form.val('modelFormFilter', data);
        }
        
        layer.open({
            type: 1,
            title: data ? '配置AI引擎' : '接入新引擎',
            area: ['600px', '500px'],
            content: $('#modelForm'),
            shade: 0.8,
            success: function(layero, index){
                layero.find('.layui-layer-title').css({
                    'background': '#111', 
                    'color': 'var(--neon-blue)', 
                    'border-bottom': '1px solid #333'
                });
                layero.find('.layui-layer-content').css('background', '#1a1a2e');
            }
        });
    }
    
    window.editModel = function(data) {
        openModelForm(data);
    }

    form.on('submit(saveModel)', function(data){
        $.ajax({
            url: '{{ url_for("backend.save_ai_model") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data.field),
            success: function(res) {
                if(res.success) {
                    layer.closeAll();
                    layer.msg('保存成功', {icon: 1});
                    loadModels(1);
                } else {
                    layer.msg(res.message, {icon: 2});
                }
            }
        });
        return false;
    });
    
    window.deleteModel = function(id) {
        layer.confirm('确定要卸载该AI引擎吗？', {
            title: '警告',
            btn: ['确认卸载', '取消']
        }, function(index){
            $.ajax({
                url: '{{ url_for("backend.delete_ai_model") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({id: id}),
                success: function(res) {
                    if(res.success) {
                        layer.msg('已卸载');
                        loadModels(1);
                    }
                }
            });
            layer.close(index);
        });
    }
    
    window.testModel = function(id, name) {
        currentTestId = id;
        $('#chatBox').html('<div class="chat-msg ai">系统: 已连接到 ' + name + '，请发送消息测试。</div>');
        $('#testInput').val('');
        
        layer.open({
            type: 1,
            title: '连接测试终端: ' + name,
            area: ['500px', '450px'],
            content: $('#testModal'),
            shade: 0.8,
            success: function(layero) {
                layero.find('.layui-layer-title').css({'background': '#111', 'color': 'var(--neon-blue)'});
                layero.find('.layui-layer-content').css('background', '#1a1a2e');
            }
        });
    }
    
    window.sendTestMsg = function() {
        var msg = $('#testInput').val();
        if(!msg) return;
        
        $('#chatBox').append('<div class="chat-msg user">我: ' + msg + '</div>');
        $('#testInput').val('');
        
        var aiMsgId = 'ai-msg-' + new Date().getTime();
        $('#chatBox').append('<div class="chat-msg ai" id="' + aiMsgId + '">AI: </div>');
        $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight);
        
        fetch('{{ url_for("backend.test_ai_model") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({id: currentTestId, message: msg})
        }).then(response => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            function read() {
                reader.read().then(({done, value}) => {
                    if (done) {
                        return;
                    }
                    buffer += decoder.decode(value, {stream: true});
                    const parts = buffer.split('\n\n');
                    buffer = parts.pop(); 
                    
                    parts.forEach(part => {
                        if (part.startsWith('data: ')) {
                            const dataStr = part.slice(6);
                            if (dataStr === '[DONE]') return;
                            
                            try {
                                const data = JSON.parse(dataStr);
                                if (data.content) {
                                    $('#' + aiMsgId).append(data.content.replace(/\n/g, '<br>'));
                                    $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight);
                                }
                                // Token usage display removed as per user request
                                // if (data.usage) {
                                //     $('#' + aiMsgId).after('<div style="color: #666; font-size: 10px; padding-left: 10px;">Token消耗: ' + data.usage + '</div>');
                                // }
                                if (data.error) {
                                    $('#' + aiMsgId).append('<br><span style="color:red">Error: ' + data.error + '</span>');
                                }
                            } catch (e) {
                                console.error('Parse error', e);
                            }
                        }
                    });
                    read();
                });
            }
            read();
        }).catch(err => {
            $('#' + aiMsgId).append('<br><span style="color:red">通信失败: ' + err + '</span>');
        });
    }
    
    $('#testInput').on('keypress', function(e){
        if(e.which == 13) sendTestMsg();
    });
    
    loadModels(1);
});
</script>
{% endblock %}